#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Å ngrok

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ —Å ngrok..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ ngrok
if ! command -v ngrok &> /dev/null; then
    echo "‚ùå ngrok –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok:"
    echo "  macOS: brew install ngrok/ngrok/ngrok"
    echo "  –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ —Å https://ngrok.com/download"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ ngrok
if pgrep -x "ngrok" > /dev/null; then
    echo "‚ö†Ô∏è  ngrok —É–∂–µ –∑–∞–ø—É—â–µ–Ω. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
    pkill ngrok
    sleep 2
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º production —Å–µ—Ä–≤–µ—Ä (gunicorn) –≤ —Ñ–æ–Ω–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π
echo "üì° –ó–∞–ø—É—Å–∫ production —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8000..."
# Load environment variables
if [ -f .env ]; then
    export $(cat .env | grep -v '#' | xargs)
    if [ -n "$OPENAI_API_KEY" ]; then
        echo "‚úÖ OPENAI_API_KEY –∑–∞–≥—Ä—É–∂–µ–Ω (–¥–ª–∏–Ω–∞: ${#OPENAI_API_KEY} —Å–∏–º–≤–æ–ª–æ–≤)"
    else
        echo "‚ö†Ô∏è  OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!"
    fi
fi
gunicorn --workers 2 --timeout 600 --graceful-timeout 600 --bind 0.0.0.0:8000 --daemon --pid gunicorn.pid "app.main:app"
# –ñ–¥–µ–º —Å–æ–∑–¥–∞–Ω–∏—è PID —Ñ–∞–π–ª–∞
sleep 2
FLASK_PID=$(cat gunicorn.pid 2>/dev/null || echo "")

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! curl -s http://localhost:8000 > /dev/null 2>&1; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ."
    kill $FLASK_PID 2>/dev/null
    exit 1
fi

echo "‚úÖ Flask —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $FLASK_PID)"

# –ó–∞–ø—É—Å–∫–∞–µ–º ngrok
echo "üåê –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è..."
ngrok http 8000 > /dev/null &
NGROK_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ ngrok
sleep 3

# –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | python3 -c "import sys, json; data = json.load(sys.stdin); print(data['tunnels'][0]['public_url'] if data.get('tunnels') else '')" 2>/dev/null)

if [ -z "$NGROK_URL" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ngrok URL"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ngrok –∑–∞–ø—É—â–µ–Ω: http://localhost:4040"
    kill $FLASK_PID $NGROK_PID 2>/dev/null
    exit 1
fi

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "‚úÖ –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
echo "   $NGROK_URL"
echo ""
echo "üìã –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç URL –≤ n8n:"
echo "   $NGROK_URL/analyze"
echo ""
echo "üîç –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ngrok: http://localhost:4040"
echo ""
echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    kill $NGROK_PID 2>/dev/null
    if [ -f gunicorn.pid ]; then
        kill $(cat gunicorn.pid) 2>/dev/null
        rm -f gunicorn.pid
    fi
    pkill -f gunicorn 2>/dev/null
    echo "‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    exit 0
}

trap cleanup SIGINT SIGTERM

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait

